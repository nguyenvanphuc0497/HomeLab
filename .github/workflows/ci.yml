name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  bootstrap:
    name: Bootstrap
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Show repo status
        run: |
          git status -sb
          ls -la

  markdown-lint:
    name: Markdown lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install markdownlint
        run: npm install -g markdownlint-cli
      - name: Lint markdown
        continue-on-error: true
        run: |
          markdownlint "**/*.md" --disable MD013 MD033 MD041 MD033 || echo "‚ö†Ô∏è  Some markdown files have warnings (non-blocking)"

  yaml-lint:
    name: YAML lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install yamllint
        run: pip install --quiet yamllint
      - name: Lint YAML (relaxed)
        continue-on-error: true
        run: |
          yamllint -d '{extends: relaxed, rules: {line-length: disable}}' . || echo "‚ö†Ô∏è  Some YAML files have warnings (non-blocking)"

  compose-validate:
    name: Validate Docker Compose
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install Docker Compose plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin
          docker compose version
      - name: Check script exists
        run: |
          ls -la scripts/validate-compose.sh
          chmod +x scripts/validate-compose.sh
      - name: Validate all Compose files
        id: validate
        continue-on-error: false
        run: |
          set +e  # Don't exit immediately on error
          bash scripts/validate-compose.sh > validation-report.txt 2>&1
          VALIDATION_EXIT=$?
          
          echo "=== Validation Report ==="
          cat validation-report.txt
          echo "========================"
          
          if [ $VALIDATION_EXIT -eq 0 ]; then
            echo "‚úÖ All compose files validated successfully"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Validation failed with exit code: $VALIDATION_EXIT"
            echo "status=failed" >> $GITHUB_OUTPUT
          fi
          
          exit $VALIDATION_EXIT
      - name: Upload validation report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: validation-report
          path: validation-report.txt
          retention-days: 7

  compose-dry-run:
    name: Dry Run - Preview Deployments
    runs-on: ubuntu-latest
    needs: [compose-validate]
    strategy:
      matrix:
        server: [raspi3, raspi4, raspi5, intel-nuc, amd-ovm]
    steps:
      - uses: actions/checkout@v4
      - name: Install Docker Compose plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin
      - name: Dry run for ${{ matrix.server }}
        id: dry-run
        working-directory: servers/${{ matrix.server }}
        run: |
          echo "üîç Dry run for ${{ matrix.server }}..."
          SERVICES=$(docker compose -f docker-compose.yml config --services 2>/dev/null || echo "‚ö†Ô∏è  Some variables may be undefined")
          IMAGES=$(docker compose -f docker-compose.yml config 2>/dev/null | grep -E "^\s+image:" | sed 's/.*image: //' | sort -u || echo "N/A")
          echo "services<<EOF" >> $GITHUB_OUTPUT
          echo "$SERVICES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "images<<EOF" >> $GITHUB_OUTPUT
          echo "$IMAGES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "‚úÖ Dry run completed"
      - name: Upload dry-run report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dry-run-${{ matrix.server }}
          path: |
            servers/${{ matrix.server }}/docker-compose.yml
          retention-days: 7

  compose-test-deploy:
    name: Test Deploy (Platform Emulation)
    runs-on: ubuntu-latest
    needs: [compose-validate]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      matrix:
        server:
          - name: raspi5
            platform: linux/arm64
          - name: raspi4
            platform: linux/arm64
          - name: intel-nuc
            platform: linux/amd64
    steps:
      - uses: actions/checkout@v4
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Install Docker Compose plugin
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose-plugin qemu-user-static
          docker compose version
      - name: Test deploy ${{ matrix.server.name }} (${{ matrix.server.platform }})
        working-directory: servers/${{ matrix.server.name }}
        env:
          DOCKER_DEFAULT_PLATFORM: ${{ matrix.server.platform }}
        run: |
          echo "üß™ Testing deploy for ${{ matrix.server.name }} (platform: ${{ matrix.server.platform }})..."
          docker compose -f docker-compose.yml pull || echo "‚ö†Ô∏è  Some images may not be available for this platform"
          docker compose -f docker-compose.yml config > /dev/null && echo "‚úÖ Configuration valid"
          echo "‚úÖ Test deploy validation passed"

  deploy:
    name: Deploy to Server
    runs-on: self-hosted
    needs: [compose-validate, compose-dry-run]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    strategy:
      fail-fast: false
      matrix:
        server: [raspi5]
    steps:
      - uses: actions/checkout@v4
      - name: Deploy to ${{ matrix.server }}
        id: deploy
        working-directory: servers/${{ matrix.server }}
        run: |
          echo "üöÄ Deploying to ${{ matrix.server }}..."
          make deploy > deploy.log 2>&1 && echo "status=success" >> $GITHUB_OUTPUT || (echo "status=failed" >> $GITHUB_OUTPUT && exit 1)
          echo "‚úÖ Deployment completed"
      - name: Verify deployment
        id: verify
        working-directory: servers/${{ matrix.server }}
        run: |
          echo "üîç Verifying deployment..."
          make ps > verify.log 2>&1 && echo "status=success" >> $GITHUB_OUTPUT || echo "status=warning" >> $GITHUB_OUTPUT
      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-${{ matrix.server }}-logs
          path: |
            servers/${{ matrix.server }}/deploy.log
            servers/${{ matrix.server }}/verify.log
          retention-days: 30

  ci-summary:
    name: CI Summary Report
    runs-on: ubuntu-latest
    needs: [markdown-lint, yaml-lint, compose-validate, compose-dry-run]
    if: always()
    steps:
      - name: Generate Summary Report
        run: |
          echo "# üìä CI/CD Summary Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ‚úÖ Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Markdown Lint | ${{ needs.markdown-lint.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| YAML Lint | ${{ needs.yaml-lint.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Compose Validate | ${{ needs.compose-validate.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dry Run | ${{ needs.compose-dry-run.result == 'success' && '‚úÖ Passed' || '‚ùå Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Check the **Artifacts** section below to download detailed reports." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üîç Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.compose-validate.result }}" != "success" ]; then
            echo "‚ùå **Action Required:** Fix compose file validation errors" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ All validations passed! Ready for deployment." >> $GITHUB_STEP_SUMMARY
          fi

  pr-comment:
    name: Comment on PR
    runs-on: ubuntu-latest
    needs: [markdown-lint, yaml-lint, compose-validate, compose-dry-run]
    if: github.event_name == 'pull_request' && always()
    permissions:
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
      - name: Comment PR
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            try {
              const status = {
                markdown: '${{ needs.markdown-lint.result }}',
                yaml: '${{ needs.yaml-lint.result }}',
                validate: '${{ needs.compose-validate.result }}',
                dryrun: '${{ needs.compose-dry-run.result }}'
              };
              
              const emoji = (s) => {
                if (s === 'success') return '‚úÖ';
                if (s === 'failure') return '‚ùå';
                if (s === 'cancelled') return '‚è≠Ô∏è';
                return '‚ö†Ô∏è';
              };
              
              const statusText = (s) => {
                if (s === 'success') return 'Passed';
                if (s === 'failure') return 'Failed';
                if (s === 'cancelled') return 'Cancelled';
                return 'Skipped';
              };
              
              const body = `## üîç CI/CD Validation Results
              
              | Check | Status |
              |-------|--------|
              | Markdown Lint | ${emoji(status.markdown)} ${statusText(status.markdown)} |
              | YAML Lint | ${emoji(status.yaml)} ${statusText(status.yaml)} |
              | Compose Validate | ${emoji(status.validate)} ${statusText(status.validate)} |
              | Dry Run | ${emoji(status.dryrun)} ${statusText(status.dryrun)} |
              
              **View full report:** [Actions](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
              
              ${Object.values(status).some(s => s === 'failure') ? '‚ö†Ô∏è **Please fix the errors above before merging.**' : '‚úÖ **All checks passed!**'}
              `;
              
              await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            } catch (error) {
              console.log('Failed to comment on PR:', error.message);
              console.log('This is non-blocking - check Actions tab for results');
            }
