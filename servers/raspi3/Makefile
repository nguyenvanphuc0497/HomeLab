COMPOSE ?= docker compose
STACK ?= docker-compose.yml
PLATFORM ?= linux/arm/v7

.PHONY: deploy up down pull logs ps restart check test-deploy dry-run pull-test test-down

deploy: pull up

up:
	$(COMPOSE) -f $(STACK) up -d

down:
	$(COMPOSE) -f $(STACK) down

pull:
	$(COMPOSE) -f $(STACK) pull

logs:
	$(COMPOSE) -f $(STACK) logs -f --tail=100

ps:
	$(COMPOSE) -f $(STACK) ps

restart:
	$(COMPOSE) -f $(STACK) restart

check:
	@echo "ğŸ” Validating $(STACK)..."
	@if [ -f .env ]; then \
		$(COMPOSE) -f $(STACK) config > /dev/null 2>&1 && echo "âœ… Valid" || \
			($(COMPOSE) -f $(STACK) config 2>&1 | head -20 && exit 1); \
	else \
		echo "âš ï¸  No .env file found, validating syntax only..."; \
		$(COMPOSE) -f $(STACK) config 2>&1 | grep -v "\.env" | grep -v "variable" > /dev/null && echo "âœ… Syntax valid (missing .env)" || \
			($(COMPOSE) -f $(STACK) config 2>&1 | grep -v "\.env" | head -20 || echo "âš ï¸  Some variables may be undefined (expected without .env)"); \
	fi

test-deploy: check pull-test
	@echo "ğŸ§ª Testing deploy (platform: $(PLATFORM))..."
	@echo "âš ï¸  This will start containers - use 'make test-down' to stop"
	@DOCKER_DEFAULT_PLATFORM=$(PLATFORM) $(COMPOSE) -f $(STACK) up -d

test-down:
	@echo "ğŸ›‘ Stopping test containers..."
	@$(COMPOSE) -f $(STACK) down

pull-test:
	@echo "ğŸ“¥ Pulling images for platform $(PLATFORM)..."
	@DOCKER_DEFAULT_PLATFORM=$(PLATFORM) $(COMPOSE) -f $(STACK) pull

dry-run: check
	@echo "ğŸ” Dry run - showing what would be deployed:"
	@echo ""
	@echo "ğŸ“‹ Services:"
	@$(COMPOSE) -f $(STACK) config --services
	@echo ""
	@echo "ğŸ“¦ Images to pull:"
	@$(COMPOSE) -f $(STACK) config | grep -E "^\s+image:" | sed 's/.*image: //' | sort -u
	@echo ""
	@echo "âœ… Configuration valid - ready to deploy"

